var BTFRESCA=BTFRESCA||{};BTFRESCA.util=(function(){return{getUrlParameter:function(b){b=b.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a="[\\?&]"+b+"=([^&#]*)";var d=new RegExp(a);var c=d.exec(window.location.href);if(c==null){return""}else{return c[1]}},changeUrlParameter:function(c,d,h){var a="Region=",g=c.split("?"),f=g[0],b=g[1],j="country=";if(b){var g=b.split("&");for(var e in g){if(g[e].indexOf(d)==-1){a+=j+g[e];j="&"}}}return f+"?"+a+j+d+"="+h}}}());BTFRESCA.storeFinder=(function(){var a,h,l=[],b=new Array,k,e,d,c=[];var j=17;var g=10;var f={origin:null,destination:null,travelMode:google.maps.DirectionsTravelMode.DRIVING,unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,waypoints:null,optimizeWaypoints:false,provideRouteAlternatives:false,avoidHighways:false,avoidTolls:false,region:""},m=$("#store_subselection");return{init:function(){var n={zoom:j,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:true,navigationControl:true,mapTypeControl:true,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.TOP_LEFT},navigationControlOptions:{position:google.maps.ControlPosition.LEFT},streetViewControl:true};var r=document.getElementById("map_canvas");a=new google.maps.Map(r,n);if(l.length>0){if(l.length==1){var o;var p=new google.maps.LatLngBounds();for(i=0;i<l.length;i++){h=l[i];o=new google.maps.LatLng(h.lat,h.lon);p.extend(o);a.setCenter(new google.maps.LatLng(h.lat,h.lon));d=new google.maps.Marker({position:o,title:h.name});this.storePopup(d,h);d.setIcon("/pws/images/maps/default_marker.png")}d.setMap(a);a.setCenter(o);a.setZoom(15)}}var q=BTFRESCA.util.getUrlParameter("country");if(q===""){window.location="/pws/StoreFinder.ice?country=GB&findStore=findStore&page=stores"}},storesByRegion:function(p,o){b=[];var q='<div id="store_headings"><div class="store_heading" id="store_name_heading">Store</div><div class="store_heading" id="store_name_city">Store type</div><div class="store_heading" id="store_name_postcode">Postcode</div><div class="store_heading last_col" id="store_name_telephone">Telephone no.</div></div>';for(var n=0;n<l.length;n++){if(l[n].region==p){this.addDisplayStore(l[n])}}$("#stores").prepend(q);this.storeDisplayPage(o);this.storeDisplayMap()},addStore:function(n){l.push(n)},getStoreById:function(n){var p={},o=0;if(l!="undefined"){for(o=0;o<l.length;o++){if(l[o].id===n){p=l[o]}}}return p},addDisplayStore:function(n){b.push(n)},addMarker:function(n){c.push(n)},storeDisplayPage:function(o){if(b.length>0){$(".store").hide();for(var n=0;n<b.length;n++){$(o+b[n].id).show()}$("#stores").show()}},storeDisplayPageSubselection:function(p){var q={};var n=$(p);if(b.length>0){n.empty();for(var o=0;o<b.length;o++){q=$("#store_"+b[o].id);q.clone().appendTo(n)}n.show()}},clearMarkers:function(){for(var n=0;n<c.length;n++){c[n].visible=false;c[n].setMap(null)}c=[]},storeDisplayMap:function(){var q;var p=new google.maps.LatLngBounds();var n={};this.clearMarkers();for(var o=0;o<b.length;o++){n=b[o];q=new google.maps.LatLng(n.lat,n.lon);d=new google.maps.Marker({position:q,title:n.name});if(n.concession=="F"){d.setIcon("/pws/images/store_marker_blue.gif")}else{d.setIcon("/pws/images/store_marker_red.gif")}d.setMap(a);this.addMarker(d);p.extend(q);this.storePopup(d,n)}if(b.length>0){if(b.length==1){a.setCenter(q);a.setZoom(15)}else{a.fitBounds(p)}}},storePopup:function(p,x){var n=false;var w=$("#store_"+x.id);var z='<div class="map_title">'+w.find(".store_name").html()+"</div>";var t='<div class="map_addr1">'+w.find(".store_address1").html()+"</div>";var s='<div class="map_addr2">'+w.find(".store_address2").html()+"</div>";var r='<div class="map_addr3">'+w.find(".store_address3").html()+"</div>";var B='<div class="map_city">'+w.find(".store_city").html()+"</div>";var o='<div class="map_county">'+w.find(".store_county").html()+"</div>";var q='<div class="map_postcode">'+w.find("div.store_postcode").html()+"</div>";var A=w.find("div.store_phone").clone();A.find("span.telno").remove();var u='<div class="map_phone">'+A.html()+"</div>";var v=this.storePopupForm(x.id);var y='<div class="map_info">'+t+s+r+B+o+q+u+"</div>"},storePopupForm:function(n){var o='<form action="" class="directions_form"><fieldset><label for="map_postcode_'+n+'">Postcode</label><input id="map_postcode_'+n+'" value="Postcode" class="map_postcode" type="text" size="10" value="" autocomplete="off"/><input type="image" src="/pws/client/images/storelocator/btn_get_directions.jpg" id="postcode_directions_'+n+'" class="postcode_directions" alt="Get directions to this store" /></fieldset></form>';return o},postcodeToStore:function(q,r,v){var n=false,t=new google.maps.DirectionsService(),u=new google.maps.DirectionsRenderer(),s=$("#directions_panel"),o=this.getStoreById(v);u.setMap(a);u.setPanel(document.getElementById("directions_panel"));var p={unitSystem:google.maps.DirectionsUnitSystem.IMPERIAL,provideRouteAlternatives:true,origin:q,destination:new google.maps.LatLng(o.lat,o.lon),travelMode:google.maps.DirectionsTravelMode.DRIVING};t.route(p,function(x,w){if(w==google.maps.DirectionsStatus.OK){s.empty();u.setDirections(x);n=true}});return n},toRad:function(n){return n*Math.PI/180},distHaversine:function(p,s,o,r){var q=6371;var u=this.toRad(o-p);var n=this.toRad(r-s);var w=Math.sin(u/2)*Math.sin(u/2)+Math.cos(this.toRad(p))*Math.cos(this.toRad(o))*Math.sin(n/2)*Math.sin(n/2);var v=2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w));var t=q*v;return t},displayDistances:function(){if(b.length>0){for(var n=0;n<b.length;n++){h=b[n];$("#distance_"+h.id).text(h.distance+" miles")}}},sortStoreByDistance:function(o,n){var p=o.distance-n.distance;return((parseFloat(p)==parseInt(p))&&!isNaN(p))?p:""},postcodeIsValid:function(o){var n=true;if(o.match(/^([A-PR-UWYZ0-9][A-HK-Y0-9][AEHMNPRTVXY0-9]?[ABEHMNPRVWXY0-9]? {1,2}[0-9][ABD-HJLN-UW-Z]{2}|GIR 0AA)$/i)){if(o===""||o.toLowerCase()=="postcode"||o.length<6){n=false}}return n},findNearestStores:function(o){var r=true;var p=new Object();p.lat=0;p.lon=0;p.retCode=false,radius=0;if(this.postcodeIsValid(o)){var q=new google.maps.Geocoder(),n=this;q.geocode({address:o+" uk"},function(t,s){if(s==google.maps.GeocoderStatus.OK){BTFRESCA.storeFinder.scrollToStoreSelection($("#store_subselection"));p.retCode=true;p.lat=t[0].geometry.location.lat();p.lon=t[0].geometry.location.lng();n.displayNearestStores(o,p)}else{alert("Sorry, we are unable to find postcode "+o+". Please try again, or use the Display All Stores button to find your nearest store.")}})}else{alert("Please enter a valid UK postcode")}},displayNearestStores:function(p,s){b=[];var o='<div id="store_headings"><div class="store_heading" id="store_name_heading">Store</div><div class="store_heading" id="store_name_city">Store type</div><div class="store_heading" id="store_name_postcode">Postcode</div><div class="store_heading" id="store_name_distance">Distance</div><div class="store_heading last_col" id="store_name_telephone">Telephone no.</div></div>';for(var q=0,r=l.length;q<r;q++){var n=l[q];var t=this.distHaversine(s.lat,s.lon,n.lat,n.lon);n.distance=Math.round(t)}l.sort(this.sortStoreByDistance);if(g>1){for(var q=0,r=g;q<r;q++){if(l[q]){this.addDisplayStore(l[q])}}}$("#store_subselection").before(o);$("#store_headings").before('<h2 class="search_result_heading">Search results</h2>');this.storeDisplayPageSubselection("#store_subselection");this.displayDistances()},listAllStores:function(n){n.click(function(){$(".search_result_heading").hide();$("#store_headings").hide();$("#store_subselection").hide();$("#all_stores_list").show()})},listByRegion:function(){var n=$("#region").val();if(n!==""){this.formatMapContainer();$("#postcode").val("");$("#stores").hide();$("#store_subselection, #store_headings").show();BTFRESCA.storeFinder.storesByRegion(n,"#store_");this.scrollToStoreSelection(m)}},listByNearestStores:function(){var n=$("#postcode").val();if(!n&&$(".single_store")){n=$(".postcode").val()}if(n!=="Postcode"&&n!==""&&n&&n.indexOf("e.g.")==-1){this.formatMapContainer();$("#stores").hide();BTFRESCA.storeFinder.findNearestStores(n);$("#store_headings").show();$(".store").show();this.scrollToStoreSelection(m)}},getDirections:function(){BTFRESCA.storeFinder.directionsSearchSetup()},initialiseStoreData:function(){var n=$("#map_canvas");if(n.length>0){BTFRESCA.storeFinder.init()}},formatMapContainer:function(){$("#store_header").show();$("#window_print").show();$("#map_directions").hide()},scrollToStoreSelection:function(n){if(n.is(":visible")){$("html, body").animate({scrollTop:n.offset().top},800)}}}}());var country=BTFRESCA.util.getUrlParameter("country");if(country===""){window.location="/pws/StoreFinder.ice?country=GB&findStore=findStore&page=stores"}function InfoBox(b){google.maps.OverlayView.call(this);this.latlng_=b.latlng;this.map_=b.map;this.content=b.content;this.store=b.store;this.offsetVertical_=-205;this.offsetHorizontal_=-105;this.height_=218;this.width_=243;var a=this;this.boundsChangedListener_=google.maps.event.addListener(this.map_,"bounds_changed",function(){return a.panMap.apply(a)});this.setMap(this.map_)}InfoBox.prototype=new google.maps.OverlayView();InfoBox.prototype.remove=function(){if(this.div_){this.div_.parentNode.removeChild(this.div_);this.div_=null}};InfoBox.prototype.draw=function(){this.createElement();if(!this.div_){return}var a=this.getProjection().fromLatLngToDivPixel(this.latlng_);if(!a){return}this.div_.style.width=this.width_+"px";this.div_.style.left=(a.x+this.offsetHorizontal_)+"px";this.div_.style.height=this.height_+"px";this.div_.style.top=(a.y+this.offsetVertical_)+"px";this.div_.style.display="block"};InfoBox.prototype.createElement=function(){var d=this.getPanes();var a=this.div_;var e=this.store;if(!a){a=this.div_=document.createElement("div");a.style.border="0px none";a.style.position="absolute";a.style.background="url('/pws/images/map_popup_new.gif')";a.style.width=this.width_+"px";a.style.height=this.height_+"px";a.className="map_popup";var b=document.createElement("div");b.style.padding="0px 0px 5px 10px";b.innerHTML=this.content;var f=document.createElement("div");f.style.textAlign="right";f.style.padding="4px 13px 0px 0px";var j=document.createElement("img");j.className="stores_close_button";j.setAttribute("height",19);j.setAttribute("width",21);j.src="/pws/images/btn_close.jpg";f.appendChild(j);function g(k){return function(){k.setMap(null)}}function c(k){k.focus()}a.appendChild(f);a.appendChild(b);a.style.display="none";d.floatPane.appendChild(a);$("#map_postcode_"+e.id).click(function(){c(this);$(this).attr("value","")});$("#by_road").click(function(n){n.preventDefault(n);var m=$(this);var l=$("#directions_from_postcode").val();var k=$("#store_id").val();var o=m.prop("id");if(l!==""){BTFRESCA.storeFinder.postcodeToStore(l,o,k)}});$(j).hover(function(){$(this).css("cursor","pointer")},function(){});var h=this;$(j).click(function(){h.hide()});this.panMap()}else{if(a.parentNode!=d.floatPane){a.parentNode.removeChild(a);d.floatPane.appendChild(a)}else{}}};InfoBox.prototype.hide=function(){if(this.div_){this.div_.style.visibility="hidden"}};InfoBox.prototype.show=function(){if(this.div_){this.div_.style.visibility="visible"}};InfoBox.prototype.panMap=function(){var C=this.map_;var e=C.getBounds();if(!e){return}var E=this.latlng_;var v=this.width_;var x=this.height_;var f=this.offsetHorizontal_;var d=this.offsetVertical_;var p=0;var o=0;var u=C.getDiv();var y=u.offsetWidth;var t=u.offsetHeight;var D=e.toSpan();var w=D.lng();var l=D.lat();var n=w/y;var k=l/t;var j=e.getSouthWest().lng();var q=e.getNorthEast().lng();var B=e.getNorthEast().lat();var b=e.getSouthWest().lat();var a=E.lng()+(f-p)*n;var c=E.lng()+(f+v+p)*n;var s=E.lat()-(d-o)*k;var m=E.lat()-(d+x+o)*k;var r=(a<j?j-a:0)+(c>q?q-c:0);var z=(s>B?B-s:0)+(m<b?b-m:0);var A=C.getCenter();var h=A.lng()-r;var g=A.lat()-z;C.setCenter(new google.maps.LatLng(g,h));google.maps.event.removeListener(this.boundsChangedListener_);this.boundsChangedListener_=null};$(document).ready(function(){if(BTFRESCA.storeFinder){if($("#map_canvas").length>0){BTFRESCA.storeFinder.init()}BTFRESCA.storeFinder.listByRegion();BTFRESCA.storeFinder.listByNearestStores();BTFRESCA.storeFinder.listAllStores($("#view_all_stores"))}$("#by_road").click(function(){var a=$("#directions_from_postcode").val();if(a!==""||a!=="e.g. London or EC1N 8TS"){BTFRESCA.storeFinder.postcodeToStore(a,$(this).prop("id"),$("#store_id").attr("name"))}})});