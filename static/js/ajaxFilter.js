(function(a){a.fn.ajaxFilter=function(d){var n=a.extend({},a.fn.ajaxFilter.defaults,d),m=a(this),q="",i=false,f=true,r=basePath,g,h,p;function k(){g=a("#"+n.listingsContainerId);h=a('<div id="'+n.overlayLoaderId+'">'+n.overlayMessage+"</div>").css("opacity",0);if(a("#"+n.overlayLoaderId).length<1){g.append(h)}}function o(){var x=a("#content"),w=a("#"+n.overlayLoaderId),v=x.height();w.css({height:v+"px"});a("#"+n.overlayLoaderId).show().fadeTo(n.fadeSpeed,n.overlayOpacity)}function s(){if(a.cookie("view_format")===null){a.cookie("view_format",a("#main_products_list_page").data("view"),{expires:31,path:"/"})}a("#"+n.viewingFormatId).find("a#view_"+a.cookie("view_format")).addClass("current")}function j(x,z){var y=a(x),w="",v={};w="#s"+a(x).attr("id").substring(1);v=a(w);q=a.deparam.querystring(y.attr("href")).addFilter.replace(/ /g,"+");if(y.hasClass(n.appliedClass)){y.removeClass(n.appliedClass);if(y.parents("."+n.filterGroupClass).find("."+n.appliedClass).length===0){y.parents("."+n.filterGroupClass).removeClass(n.appliedClass)}v.removeClass("applied2")}else{y.addClass(n.appliedClass);y.parents("."+n.filterGroupClass).addClass(n.appliedClass);v.addClass("applied2")}if(typeof(z)==="function"){z()}}function c(){var z=[],x=a("."+n.filterGroupClass+"."+n.appliedClass,m),D,v,B,A,C,w=[],y="";for(B=0;B<x.length;B++){C=a(x[B]);D=C.find("."+n.appliedClass+":not(."+n.disabledClass+")");w=[];for(A=0;A<D.length;A++){v=a.deparam.querystring(a(D[A]).attr("href"));w.push(v.filterValue);y=v.addFilter.replace(/ /g,"+")}z.push(y+"!"+w.join(","))}return{filters:z.join("$"),resultPage:0}}function t(v){if(!a(v).hasClass(n.disabledClass)){i=true;j(v,function(){a.bbq.pushState(c())})}}function u(){a("#"+n.overlayLoaderId).fadeTo(n.fadeSpeed,0).hide()}function e(D){var y,A,z,C,w,x,B,v;i=true;a("."+n.appliedClass,m).removeClass(n.appliedClass);if(a.deparam.fragment().filters!==undefined&&a.deparam.fragment().filters!==""&&a.deparam.fragment().filters!=="!"){y=a.deparam.fragment().filters.split("$");for(A=0;A<y.length;A++){C=y[A];w=C.split("!");x=w[1].split(",");if(w.length===2){for(z=0;z<x.length;z++){B=x[z];v='a[href*="addFilter='+w[0].replace(/ /g,"+")+"&filterValue="+B.replace(/ /g,"+");j(m.find(v+'"]').not(v+'.5"]'))}}}}if(typeof(D)==="function"){D()}}a.fn.ajaxFilter.generateAjaxUrl=function(v){if(!v){v=basePath+window.location.hash.replace("#","&")}if(v.indexOf("productsPerPage")>-1&&v.match(/productsPerPage/g).length>1){v=v.replace("productsPerPage","originalProductsPerPage")}return v.replace(n.standardCategoryLayout,n.ajaxCategoryLayout).replace(n.standardSearchLayout,n.ajaxSearchLayout).replace(n.categoryPage,n.ajaxPage).replace(n.searchPage,n.ajaxPage)+"&loadCat=true"};a.fn.ajaxFilter.bindSortby=function(){a("#sortby").change(function(){a.bbq.pushState({sortOrder:a("option:selected",a(this)).val(),resultPage:0})})};function l(v,w){v=a.fn.ajaxFilter.generateAjaxUrl(v);if(a("body").hasClass("ly_searchresults")){v=v.replace("resultPage","page")}a.get(v,function(z){var y,x,A;redirectProduct=z.substring(z.indexOf('<div id="hidden-nextprev">')+26,z.length);redirectProduct=redirectProduct.substring(0,redirectProduct.indexOf("</div>"));if(z.indexOf(n.productClass)>-1){a("#"+n.contentContainerId).html(z).fadeIn(n.fadeSpeed,function(){u();setCategoryCookie()});if(q){a("."+n.filterGroupClass+":not(#"+q+") a:not(.reset, .applied)",m).addClass(n.disabledClass)}for(y=0;y<returnedFilters.length;y++){x=returnedFilters[y];A=x.url.replace(/%20/g," ");A=A.replace(/%27/g,"'");a('a[href$="'+A+'"]').removeClass(n.disabledClass).find(".count").html(x.count)}a("."+n.disabledClass,m).removeClass(n.appliedClass);a("a:not(."+n.disabledClass+",."+n.appliedClass+",.reset)",m).addClass("filter");a.cookie("lastSuccessfulCategory",window.location.href,{expires:31,path:"/"})}else{if(a.browser.msie&&z.indexOf(n.productDetailsIdentifier)>-1&&a.cookie("productRedirect")&&a.cookie("lastSuccessfulCategory")&&redirectProduct===a.cookie("productRedirect")){location.replace(a.cookie("lastSuccessfulCategory"))}else{if(z.indexOf(n.productDetailsIdentifier)>-1){a("#"+n.overlayId).html(n.overlayRedirectProductDetails);if(a.browser.msie){window.location=v}else{location.replace(v)}}else{a("#"+n.overlayId).html(n.overlayRedirectBase);location.replace(basePath)}}}a.fresca.initPopup();a.fn.ajaxFilter.bindSortby();if(typeof(w)==="function"){w()}if(typeof(n.callback)==="function"){n.callback()}s();a.cookie("productRedirect",null,{expires:31,path:"/"})})}function b(){k();var v=a.cookie("lastSuccessfulCategory");a("li.filter_group",m).hover(function(){var w=a(this),x=a("ul",w);w.addClass("filter_hover");if(x.length>0&&!x.data("positioned")){x.css({left:-Math.floor((x.outerWidth()-w.outerWidth())/2)}).data("positioned",true)}},function(){if(!i){a(this).removeClass("filter_hover")}});a("a:not(.reset)",m).click(function(){t(this);return false}).keypress(function(w){if(w.keyCode===13){t(this)}});if(n.viewingFormatId!==""||n.viewingFormatId!==undefined){s();a("#"+n.viewingFormatId+" a").live("click",function(){a.cookie("view_format",a(this).data("view"),{expires:31,path:"/"});l();return false})}a("ul."+n.paginationClass+" a").live("click",function(){var w=a(this);a("#"+n.contentContainerId).fadeOut(n.fadeSpeed,function(){var x=a.deparam.querystring(w.attr("href")).productsPerPage,y=String(x);if(a.deparam.querystring(w.attr("href")).resultPage===undefined){if(y.indexOf(",")>-1){x=y.substring(0,y.indexOf(","))}p={productsPerPage:x,resultPage:0}}else{p={resultPage:a.deparam.querystring(w.attr("href")).resultPage}}a.bbq.pushState(p)});return false});a.fn.ajaxFilter.bindSortby();if(n.productsPerPageSelectId!==""){a("#"+n.productsPerPageSelectId).change(function(){a.bbq.pushState({productsPerPage:a("option:selected",a(this)).val(),resultPage:0})})}a.fn.hashchange.src="/pws/document-domain.html";a.fn.hashchange.domain=document.domain;a(window).bind("hashchange",function(){o();if(i===false&&window.location.hash.indexOf("#")>-1){e(function(){l()});f=false}else{if(i===true){l();f=false}else{if(!f){a("."+n.appliedClass,m).removeClass(n.appliedClass);l(r)}}}i=false});a(window).trigger("hashchange");u();setCategoryCookie();if(v===null){a.cookie("lastSuccessfulCategory",window.location.href,{expires:31,path:"/"})}}b()};a.fn.ajaxFilter.defaults={disabledClass:"disabled",appliedClass:"applied",productClass:"productsList",productDetailsIdentifier:"product_info",filterGroupClass:"filter_group",overlayId:"listings_overlay",listingsContainerId:"content",contentContainerId:"productsContainer",paginationClass:"pagination",sortSelectId:"sortby",productsPerPageSelectId:"products_per_page",standardCategoryLayout:"list.layout",ajaxCategoryLayout:"categorylistajax.layout",standardSearchLayout:"searchresults.layout",ajaxSearchLayout:"searchresultsajax.layout",categoryPage:"ProductCategoryAttributeLink.ice",searchPage:"CatalogueSearch.ice",ajaxPage:"AJProductFiltering.ice",fadeSpeed:250,overlayOpacity:0.8,overlayMessage:'<img id="listings-ajax-loader" src="/pws/images/loader.gif" alt="Loading..." />',overlayLoaderId:"ajax_overlay",overlayRedirectProductDetails:"<p>Found 1 product matching your criteria.</p><p>Loading product details page...</p>",overlayRedirectBase:"<p>Something went wrong, removing all filters...</p>",viewingFormatId:"views"}}(jQuery));