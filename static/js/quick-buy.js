(function(a){a.fresca={updateText:"Updating",popups:[],submittingOverlay:null,loadingImage:null,initPopup:function(){if(a("div#quickbuy").length==0){a("body").append('<div id="quickbuy"/>');a("div#quickbuy").css({display:"none",position:"absolute",zIndex:6001});this.loadingImage=a('<img id="popup_loading_image />').attr("src","/pws/images/loader.gif");this.submittingOverlay=a('<div id="adding_to_bag_overlay" />')}a("#productsList .productCont, #prodListGoesWith li.productCont, #prodListYMAL li.productCont, #recently_viewed_products .productCont").each(function(){if(a(this).find("span.quickbuy").length>0){var b=new Array();b.trigger=a(this).find("span.quickbuy");b.id=a(this).attr("id").split("_")[1];b.productLink=a(this).find("a.view_product").clone();b.url="/pws/AJProductDetails.ice?layout=quickbuy.pop.layout&ProductID="+b.id+"&tabInfo=true";b.container=a("div#quickbuy");b.height=a(this).outerHeight();a.fresca.popups.push(b)}});a.fresca.createPopups()},createPopups:function(){a.each(a.fresca.popups,function(c,b){a.fresca.createPopupAction(b)})},createPopupAction:function(b){b.trigger.click(function(f){var d=a(this).parents(".productCont").offset().top-1;var c=a(this).parents(".productCont").offset().left;if(a(this).parents("body.ly_productdetails").length>0){c=c-20;d=d-10}if(d+parseInt(b.container.height())>(a("#page").height()-a("#footer").height())){d=a("#page").height()-a("#footer").height()-parseInt(b.container.height())}a.fresca.showPopup(b,f,d,c);return false})},showPopup:function(b,g,j,k){b.container.removeShadow();var d=b.height;if(a(this).parents("body.ly_productdetails").length>0){d=d+50}if(d<225){d=215}var h=10;if(a("html").is(".ie6")||a("html").is(".ie7")){h=12}else{if(a("html").is(".ie8")){h=11}}b.container.css({display:"block",top:j,left:k,height:d+h+"px"}).addClass("loading");b.container.dropShadow({blur:2,left:0,opacity:0.1,top:0});var i=j+b.container.height();var f=a("div#page").height();if(i>f){b.container.animate({top:f-b.container.height()},1,function(){b.container.css("visibility","visible");a.fresca.loadPopupContent(b,b.url)})}else{b.container.css("visibility","visible");a.fresca.loadPopupContent(b,b.url)}var c=parseInt(a(b.container).position().top-((a(window).height()-a(b.container).height())/2)+100);a(window).scrollTo(c,800);a(window).resize(function(){if(b.container.is(":visible")){b.container.removeShadow();if(a.browser.msie&&a.browser.version<8){var e=((parseInt(a(window).width())-parseInt(b.container.css("width"))-a("#page").offset().left)/2);b.container.css({left:e})}else{var e=a("#page").offset().left+((parseInt(a(window).width())-parseInt(b.container.css("width")))/2);b.container.redrawShadow()}}})},hidePopup:function(b){b.container.css({display:"none",top:"0",left:"0"});b.container.removeShadow();a(window).unbind("keyup")},loadPopupContent:function(b,d){var c=this;a.fresca.getLoaderContent(b);a.ajax({url:d,success:function(e){b.container.empty().removeClass("loading").append(e);Cufon("#quickbuy #quickbuy_title");if(!(a.browser.msie&&a.browser.version==6)){Cufon.replace("button.submit_quick_buy",{fontFamily:"DIN Habitat Regular"})}a.fresca.createSwatchActions(b);a.fresca.createInteractions(b);a.fresca.createFormAction(b);a.fresca.createQuantityActions();a("#quickbuy_close").click(function(){a.fresca.hidePopup(b)});if(a("ul#apply_filter li.filter_group").length>0){a("ul#apply_filter li.filter_group ul li a").click(function(){a.fresca.hidePopup(b)});a("ul#apply_filter li.filter_group ul li span").click(function(){a.fresca.hidePopup(b)})}a(window).bind("keyup",function(f){if(f.keyCode=="27"){a.fresca.hidePopup(b)}});Cufon.replace("span#quickbuy_close",{fontFamily:"DIN Habitat Regular"});if(b.height<180){b.height=219}a(b.container).find("#quickbuy_content").css("height",b.height-39+"px");if(a("html").is(".ie")){a(b.container).find("#quickbuy_content").css("height",b.height-44+"px");a(b.container).find(".submit_quick_buy").css("margin-top","-100px")}},error:function(f,h,g){var e;e=a('<span id="quickbuy_close">Close</span><p id="quickbuy_error">Sorry, something went wrong. Please click this link to view the full product details.</p>');if(typeof(HABITAT)!="undefined"){e=a('<span id="quickbuy_close">'+HABITAT.i18n.messages.quickbuyClose+'</span><p id="quickbuy_error">'+HABITAT.i18n.messages.quickbuyFailedClickLink+"</p>")}b.container.empty().append(e).find("p#quickbuy_error").append(b.productLink);a("#quickbuy_close").click(function(){a.fresca.hidePopup(b)});Cufon.replace(a("#quickbuy_close",b.container)[0],{fontFamily:"DIN Habitat Regular"});Cufon.replace(a("#quickbuy_error",b.container)[0],{fontFamily:"DIN Habitat Regular"});Cufon.replace(b.productLink[0],{fontFamily:"DIN Habitat Regular"})}})},createSwatchActions:function(b){b.container.find("ul.alt_colours li a").each(function(c){var d=a(this).attr("href");a(this).click(function(f){b.container.addClass("loading");a.fresca.loadPopupContent(b,d);return false})})},createInteractions:function(b){a("ul#quickbuy_views li img").click(function(){a("img#quickbuy_image").attr("src",a(this).attr("src").replace("thumb","large"))})},createQuantityActions:function(d){var c=a("#value");var b=a("#selectQuantity");function e(f){c.text(Math.max(parseInt(c.text())+f.data.increment,0));b.val(Math.max(parseInt(b.val())+f.data.increment,0));return false}a("#plus").bind("click",{increment:1},e);a("#minus").bind("click",{increment:-1},e)},createFormAction:function(b){var c=this;a(b.container).find("#quickbuy_form").ajaxForm({beforeSubmit:function(){contentHeight=parseInt(a("#quickbuy_content").css("height"));if(a("html").is(".ie")){contentHeight=contentHeight+7}if(contentHeight<180){contentHeight=180}a(c.submittingOverlay).css("height",contentHeight-105+"px");a(c.submittingOverlay).css("top","105px");c.submittingOverlay.empty().append(c.loadingImage);b.container.append(c.submittingOverlay)},success:function(f,g){var d=a(b.container).find("#quickbuy_form").find("input[name=ProductID]").val();c.submittingOverlay.empty().append(f);if(a(c.submittingOverlay).children("#summary_warning").length>0){a(c.submittingOverlay).css("height",contentHeight+"px");a(c.submittingOverlay).css("top","0px")}Cufon.replace(a("p#summary_warning, p#summary_quantity",b.container)[0],{fontFamily:"DIN Habitat Regular"});Cufon.replace(a("span.button em.value",b.container)[0],{fontFamily:"DIN Habitat Regular"});c.hideElement(c.submittingOverlay,b);loadMiniBasket("reload")},error:function(f,g,e){var d;d=a('<p id="quickbuy_error">failed</p>');if(typeof(HABITAT)!="undefined"){d=a('<p id="quickbuy_error">'+HABITAT.i18n.messages.quickbuyFailed+"</p>")}c.submittingOverlay.empty().append(d);Cufon.replace(d[0],{fontFamily:"DIN Habitat Regular"});c.hideElement(c.submittingOverlay,b)}})},hideElement:function(c,b){setTimeout(function(){c.animate({opacity:0},500,function(){if(a("html").is(".ie6")){a(b.container).find(".submit_quick_buy").css("bottom","18px")}a(this).css("opacity",1);a(this).remove()})},5000)},getLoaderContent:function(b){b.container.empty();b.container.append(this.loadingImage)}}})(jQuery);